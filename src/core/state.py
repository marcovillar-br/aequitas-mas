from decimal import Decimal
from typing import Annotated, List, Optional, TypedDict
import operator
from pydantic import BaseModel, Field, field_validator, ConfigDict

# 1. PYDANTIC SCHEMAS (BOUNDARY VALIDATION)
# These schemas ensure that data generated by Tools or LLMs 
# is mathematically correct before entering the state. [cite: 132, 158]

class GrahamMetrics(BaseModel):
    """Deterministic Value Investing metrics (Graham Agent)."""
    model_config = ConfigDict(frozen=True, populate_by_name=True)
    ticker: str = Field(..., description="Company ticker on B3")
    
    # Financial Precision: Using Decimal for all monetary and ratio calculations
    # to avoid floating-point errors.
    price_to_earnings: Decimal = Field(..., alias="p_l")
    margin_of_safety: Decimal = Field(..., description="Safety margin in %")
    fair_value: Decimal = Field(..., description="Fair value calculated via Graham formula")
    
    @field_validator("ticker")
    @classmethod
    def validate_ticker(cls, v: str) -> str:
        """Validates if the ticker follows B3 standard (ends with 3, 4, or 11)."""
        # Ensured correct class scope for the validator 
        if not v.upper().endswith(("3", "4", "11")):
            raise ValueError("Invalid ticker for the Brazilian market (B3).")
        return v.upper()

class FisherAnalysis(BaseModel):
    """Context and sentiment analysis (Fisher Agent)."""
    model_config = ConfigDict(frozen=True)
    sentiment_score: float = Field(..., ge=-1, le=1)
    key_risks: List[str]
    # Ethical Traceability: Mandatory source citation [cite: 120, 179]
    source_urls: List[str] = Field(default_factory=list)

# 2. GRAPH STATE DEFINITION (LANGGRAPH)
# The state is the "living object" circulating among agents. [cite: 156, 158]

class AequitasState(TypedDict):
    """
    Representation of Aequitas-MAS Hybrid Cognitive State.
    Uses Reducers to manage accumulative memory. [cite: 156]
    """
    
    # Conversation history between Supervisor and Specialists
    messages: Annotated[List[dict], operator.add]
    
    # Target ticker for current analysis
    target_ticker: str
    
    # Decision Tensors (Structured Data) [cite: 157, 169]
    quant_metrics: Optional[GrahamMetrics]
    qual_analysis: Optional[FisherAnalysis]
    
    # Audit Log from Agent Marks (The Devil's Advocate)
    # Annotated + operator.add allows accumulating critiques without overwriting
    audit_log: Annotated[List[str], operator.add]
    
    # Routing control for the Supervisor [cite: 168]
    next_agent: str